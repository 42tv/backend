# 충전형 후원 시스템 — 결제/충전/사용/환불/정산 구현 유의점 (MD 사본)

본 문서는 **코인 충전형 후원 시스템**에서 제품(Product) 결제와 연계된 **불변식(invariants)**, **트랜잭션/동시성 제어**, **환불/정산 규칙**, **모니터링 및 리컨실리에이션**, **테스트 케이스** 등을 한 번에 복붙하여 적용할 수 있도록 정리한 가이드입니다. (현재 스키마를 최대한 존중하면서, 필요한 최소 보완 제안 포함)

---

## 1) 핵심 불변식 (Invariants)

1. **지갑 음수 금지**
   - 항상 `wallet_balances.coin_balance ≥ 0`.
   - 업데이트는 조건부로 수행:
     ```sql
     UPDATE wallet_balances
     SET coin_balance = coin_balance - :amt
     WHERE user_idx = :u AND coin_balance >= :amt;
     ```
     변경 행 수가 1이 아니면 **롤백**.

2. **구매-사용 합 일치**
   - 각 `CoinPurchase`(= CoinTopUp) 기준:
     ```
     sum(PurchaseUsage.used_coins) ≤ CoinPurchase.total_coins
     ```
   - 초과 시 즉시 알림/중단.

3. **지갑 합계 보존**
   - 사용자 기준:
     ```
     Σ(모든 CoinPurchase.total_coins)
     - Σ(모든 PurchaseUsage.used_coins)
     = WalletBalance.coin_balance
     ```
   - 주기적 리컨실리(재무 검증)로 확인.

4. **FIFO 사용 보장**
   - `PurchaseUsage` 생성은 **구매시각(purchased_at) 오름차순**으로만 차감.
   - 더 오래된 충전분이 남아있는데 새로운 충전분에서 먼저 차감되는 케이스 금지.

5. **환불 제한**
   - **완전 미사용 충전분**만 환불 가능(정책 기본값).
   - 부분 환불을 허용한다면 **미사용 잔량만** 환불(이미 사용된 코인 환불 불가).

6. **이중 집행 금지(멱등성)**
   - 동일 후원/결제 요청의 **중복 처리 금지**. (클라이언트 재시도, PG 웹훅 중복 대비)

7. **PG 거래 정합성**
   - `PaymentTransaction.status`는 PG의 승인/취소 결과와 **1:1 일치**.
   - `pg_transaction_id` **전역 유일**.

---

## 2) 스키마 보완(권장)

- **PaymentTransaction**
  - `idempotency_key String? @unique` (재시도/웹훅 중복 방지)
  - 인덱스: `@@index([status, requested_at])` (미확정 조회 최적화)

- **CoinPurchase (또는 CoinTopUp)**
  - (옵션) `remaining_coins Int` 캐시 필드  
    - 장점: FIFO 분할 차감 시 조인/합계 계산 제거 → 빠름  
    - 단점: 동시성 제어 필요(트랜잭션 절차로 해결)
  - 인덱스: `@@index([user_idx, purchased_at])` (FIFO 선택 최적화)

- **PurchaseUsage (또는 CoinUsage)**
  - 인덱스: `@@index([transfer_id])`, `@@index([purchase_id])`

- **SupportTransfer (또는 Donation)**
  - `idempotency_key String? @unique`
  - 인덱스: `@@index([receiver_idx, transferred_at])` (정산 집계 최적화)

- **WalletBalance**
  - `version Int @default(0)` (낙관적 락; 동시 차감 안전)
  - 또는 **원장(ledger)** 패턴의 캐시로만 사용(아래 5항)

> Prisma는 DB-level CHECK 제약이 제한적입니다. **애플리케이션 레벨 + 트랜잭션 + 조건부 UPDATE**로 강제하고, 필요 시 **RAW SQL**로 CHECK를 추가 권장.

---

## 3) 트랜잭션 & 동시성 (필수 절차)

### A. 충전(결제 성공 후 TopUp 반영)
1. PG 승인(웹훅/콜백) 수신 → `PaymentTransaction.status = SUCCESS` (중복 방지: `pg_transaction_id` 유니크 & `idempotency_key` 검사)
2. **DB 트랜잭션 시작**
   - `CoinPurchase` 생성(상품·수량·가격 스냅샷 확정)
   - `WalletBalance` **UPSERT**: `coin_balance += total_coins`
3. **커밋**

### B. 후원(코인 사용, FIFO)
1. **DB 트랜잭션 시작**
2. **잔액 선차감(조건부 & 버전)**
   ```sql
   -- 선차감 예시 (낙관적 락)
   UPDATE wallet_balances
   SET coin_balance = coin_balance - :amount,
       version = version + 1
   WHERE user_idx = :u
     AND coin_balance >= :amount
     AND version = :prevVersion;
