# 충전형 후원 시스템 단계별 구현 계획

## 📋 구현 현황 분석

**현재 상황:**
- a.md 파일에 8개 테이블을 포함한 완전한 충전형 시스템 설계 완료
- 한번에 구현하기에는 변경사항이 너무 크고 복잡함
- 변경 사항으로 인해 불필요해진 테이블 제거 필요(Gift 등)

**목표:**
- 사람이 이해할 수 있는 단위로 작업 분할
- 각 단계별로 독립적 테스트 및 검증 가능
- 기존 시스템에 영향 최소화하면서 점진적 구현

---

## 🎯 단계별 구현 계획

### **1단계: 기본 상품 시스템 구축**
**목표:** 코인 상품 관리 시스템의 기반 구축

**구현 대상:**
- `Product` 테이블 추가
- `PaymentTransaction` 테이블 추가
- 기본 CRUD API 구현

**작업 내용:**
1. Prisma 스키마에 Product, PaymentTransaction 모델 추가
2. Product 관리 API (생성, 조회, 수정, 삭제)
3. PaymentTransaction 생성 API (PG사 연동 준비)
4. 기본 DTO, Service, Controller 구현

**검증 방법:**
- Product CRUD 테스트
- PaymentTransaction 생성 테스트
- PG사 연동 없이 mockup 데이터로 테스트

**예상 소요시간:** 1-2일

---

### **2단계: 코인 충전 시스템 구현**
**목표:** 결제와 연동된 코인 충전 기능 구현

**구현 대상:**
- `CoinTopup` 테이블 추가
- `WalletBalance` 테이블 추가
- 충전 프로세스 구현

**작업 내용:**
1. Prisma 스키마에 CoinTopup, WalletBalance 모델 추가
2. 결제 성공 시 CoinTopup 생성 로직
3. WalletBalance 업데이트 로직 (트랜잭션 처리)
4. 충전 관련 API 구현

**검증 방법:**
- 충전 프로세스 E2E 테스트
- WalletBalance 동기화 검증
- 트랜잭션 롤백 테스트

**예상 소요시간:** 2-3일

---

### **3단계: 후원 시스템 구현**
**목표:** 코인을 사용한 후원 기능 구현

**구현 대상:**
- `Donation` 테이블 추가
- `CoinUsage` 테이블 추가 (FIFO 추적)
- 후원 프로세스 구현

**작업 내용:**
1. Prisma 스키마에 Donation, CoinUsage 모델 추가
2. FIFO 코인 소비 로직 구현 (Pessimistic Lock 사용)
3. 후원 API 구현
4. 실시간 채팅 연동 (기존 시스템과 통합)

**검증 방법:**
- FIFO 로직 정확성 테스트
- 동시성 테스트 (여러 후원 동시 발생)
- 잔액 부족 시 에러 처리 테스트

**예상 소요시간:** 3-4일

---

### **4단계: 환불 및 정산 시스템 구현**
**목표:** 환불 처리 및 정산 기능 구현

**구현 대상:**
- `RefundLog` 테이블 추가
- `Settlement` 테이블 추가
- 환불/정산 프로세스 구현

**작업 내용:**
1. Prisma 스키마에 RefundLog, Settlement 모델 추가
2. 환불 가능 여부 검증 로직 (미사용 충전분만)
3. 환불 처리 API 구현
4. 정산 계산 및 처리 API 구현

**검증 방법:**
- 환불 가능/불가능 케이스 테스트
- 정산 금액 계산 정확성 테스트
- 법적 보관 기간 준수 검증

**예상 소요시간:** 2-3일

---

### **5단계: 기존 시스템과 통합**
**목표:** 기존 Fan/Gift 시스템과의 호환성 확보

**구현 대상:**
- 기존 Gift 시스템과 Donation 시스템 병행 운영
- 데이터 마이그레이션 도구
- 통합 API 구현

**작업 내용:**
1. 기존 Fan/Gift 테이블과 새로운 Donation 테이블 연결
2. 두 시스템 병행 운영을 위한 플래그 추가
3. 기존 데이터 마이그레이션 스크립트 작성
4. 통합된 후원 내역 조회 API

**검증 방법:**
- 기존 시스템 기능 정상 작동 확인
- 마이그레이션 데이터 정합성 검증
- 통합 API 정확성 테스트

**예상 소요시간:** 2-3일

---

### **6단계: 최종 통합 및 배포**
**목표:** 프로덕션 환경 배포 준비

**구현 대상:**
- 성능 최적화
- 모니터링 및 로깅
- 프로덕션 배포

**작업 내용:**
1. 데이터베이스 인덱스 최적화
2. 로깅 및 모니터링 추가
3. 프로덕션 배포 스크립트 작성
4. 롤백 계획 수립

**검증 방법:**
- 부하 테스트
- 장애 시나리오 테스트
- 롤백 테스트

**예상 소요시간:** 1-2일

---

## 📊 단계별 의존성 다이어그램

```
1단계: Product, PaymentTransaction
    ↓
2단계: CoinTopup, WalletBalance (depends on 1단계)
    ↓
3단계: Donation, CoinUsage (depends on 2단계)
    ↓
4단계: RefundLog, Settlement (depends on 1,2,3단계)
    ↓
5단계: 기존 시스템 통합 (depends on all)
    ↓
6단계: 최종 배포 (depends on all)
```

## ⚠️ 주의사항

### **각 단계별 체크포인트:**
1. **Prisma 마이그레이션 실행 전 백업 필수**
2. **각 단계 완료 후 반드시 테스트 실행**
3. **기존 시스템 영향도 확인**
4. **법적 준수사항 (5년 보관) 검증**

### **위험 요소:**
- 대용량 트랜잭션 처리 시 성능 이슈
- FIFO 로직의 동시성 문제
- 기존 시스템과의 데이터 정합성

### **각 단계별 완료 기준:**
- [ ] 해당 단계 테이블 생성 완료
- [ ] 관련 API 구현 완료
- [ ] 단위 테스트 및 통합 테스트 통과
- [ ] 코드 리뷰 완료
- [ ] 문서화 완료

---

## 🚀 권장 작업 순서

**Week 1:** 1단계, 2단계 (기본 상품 + 충전 시스템)
**Week 2:** 3단계 (후원 시스템)
**Week 3:** 4단계, 5단계 (환불/정산 + 통합)
**Week 4:** 6단계 (최후 배포)

**총 예상 소요시간:** 약 3-4주 (11-17일)

이 계획에 따라 단계별로 진행하면 안전하고 체계적으로 충전형 후원 시스템을 구현할 수 있습니다.